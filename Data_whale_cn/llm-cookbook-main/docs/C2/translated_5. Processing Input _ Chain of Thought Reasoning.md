# Chapter 5 Processing Input - Chain of Thought Reasoning

Sometimes, language models need to perform detailed step-by-step reasoning to answer specific questions. If you rush to a conclusion, you are likely to make mistakes in the chain of reasoning. Therefore, we can use the strategy of "Chain of Thought Reasoning" to explicitly require the language model to provide a series of related reasoning steps in the query, think deeply, and then give the final answer, which is closer to the thinking process of human problem solving.

Compared with directly requiring the output result, this method of guiding the language model to reason step by step can reduce its hasty errors and generate more accurate and reliable responses. Chain of Thought Reasoning enables language models to better simulate human logical thinking and is one of the important strategies to improve the quality of their answers.

In this chapter, we will explore how to process the input of the language model to generate high-quality output. We will introduce in detail how to build a chain of thought reasoning prompt and analyze the effect of this method through case studies. Mastering this technique will help developers get better language model output.

## 1. Chain of Thought Prompt Design

The chain of thought prompt is a prompt design technique that guides the language model to perform step-by-step reasoning. It sets a system message in Prompt, requiring the language model to clarify each reasoning step before giving the final conclusion.

Specifically, Prompt can first ask the language model to state its initial understanding of the problem, and then list the steps that need to be considered., and finally analyze these factors one by one, give arguments for or against, and then draw an overall conclusion. This step-by-step reasoning method is closer to the thinking process of humans in dealing with complex problems, and can reduce the situation where the language model hastily draws wrong conclusions. Because it must gradually prove its point of view instead of directly outputting the conclusion. Through detailed thinking chain prompts, developers can obtain more reliable conclusions generated by the language model and more sufficient reasons. This prompt design technique is worth using when the language model is required for complex reasoning.

### 1.1 System message design

First, use the thought chain prompt in the system message:

```python
delimiter = "===="

system_message = f"""
Please follow the steps below to answer the customer's questions. The customer's questions will be separated by {delimiter}.

Step 1:{delimiter}First determine if the user is asking about a specific product or products. Product categories are not included in the scope.

Step 2:{delimiter}If the user asks about a specific product, confirm whether the product is in the following list. All available products:

Product: TechPro Ultrabook
Category: Computers and Laptops
Brand: TechPro
Model: TP-UB100
Warranty: 1 year
Rating: 4.5
Features: 13.3-inch display, 8GB RAM, 256GB SSD, Intel Core i5 processor
Description: A stylish and lightweight ultrabook for everyday use.
Price: $799.99

Product: BlueWave Gaming Laptop
Category: Computers & Laptops
Brand: BlueWave
Model: BW-GL200
Warranty: 2 years
Rating: 4.7
Features: 15.6-inch display, 16GB RAM, 512GB SSD, NVIDIA GeForce RTX 3060
Description: A high-performance gaming laptop that delivers an immersive experience.
Price: $1199.99

Product: PowerLite Convertible Laptop
Category: Computers & Laptops
Brand: PowerLite
Model: PL-CV300
Warranty: 1 year
Rating: 4.3
Features: 14-inch touchscreen, 8GB RAM, 256GB SSD, 360-degree hinge
Description: A versatile convertible laptop with a responsive touchscreen.
Price: $699.99

Product: TechPro Desktop Computer
Category: Computers and Laptops
Brand: TechPro
Model: TP-DT500
Warranty: 1 Year
Rating: 4.4
Features: Intel Core i7 Processor, 16GB RAM, 1TB HDD, NVIDIA GeForce GTX1660
Description: A powerful desktop computer for work and play.
Price: $999.99

Product: BlueWave Chromebook
Category: Computers and Laptops
Brand: BlueWave
Model: BW-CB100
Warranty: 1 year
Rating: 4.1
Features: 11.6-inch display, 4GB RAM, 32GB eMMC, Chrome OS
Description: A compact and affordable Chromebook for everyday tasks.
Price: $249.99

Step 3:{delimiter} If the message includes a product from the list above, list any assumptions the user made in the message, \
e.g. Laptop X is larger than Laptop Y, or Laptop Z has a 2-year warranty.

Step 4:{delimiter} If the user made any assumptions, determine if the assumptions are correct based on the product information.

Step 5:{delimiter} If the user made any incorrect assumptions, first politely correct the customer's incorrect assumptions (if applicable). \
Only mention or reference the product from the list of available products, as these are the only five products sold in the store. Answer the customer in a friendly tone.

Use the following format to answer the question:
Step 1: {delimiter} <reasoning for step 1>
Step 2: {delimiter} <reasoning for step 1>ter} <reasoning for step 2>
Step 3: {delimiter} <reasoning for step 3>
Step 4: {delimiter} <reasoning for step 4>
Reply to customer: {delimiter} <reply to customer>

Please make sure to use {delimiter} to separate the steps and the reasoning for each step in the answer above.
"""
```

### 1.2 User message test

Next, test the thought chain prompt set in the system message in the user message:

#### 1.2.1 More expensive computer

```python
from tool import get_completion_from_messages

user_message = f"""How much more expensive is the BlueWave Chromebook than the TechPro desktop computer? """

messages = [ 
{'role':'system', 
'content': system_message}, 
{'role':'user', 
'content': f"{delimiter}{user_message}{delimiter}"}, 
] 

response = get_completion_from_messages(messages)
print(response)
```

Step 1: The user asks about the price of a product.
Step 2: The user mentions two products, one of which is the BlueWave Chromebook and the other is the TechPro desktop computer.
Step 3: The user assumes that the BlueWave Chromebook is more expensive than the TechPro desktop computer.
Step 4: Based on the product information, we can determine that the user's assumption is incorrect.
Reply to customer: The price of the BlueWave Chromebook is $249.99, while the price of the TechPro desktop computer is $999.99. Therefore, the TechPro desktop computer is $750 more expensive than the BlueWave Chromebook.

#### 1.2.2 Do you have a TV?

```python
user_message = f"""Do you have a TV?"""
messages = [
{'role':'system',
'content': system_message},
{'role':'user',
'content':f"{delimiter}{user_message}{delimiter}"}, 
] 
response = get_completion_from_messages(messages)
print(response)
```

Step 1: We need to determine if the user is asking a question about a specific product or products. Product categories are not included in the scope.

Step 2: In the list of available products, no TV products are mentioned.

Reply to customer: Sorry, we currently have no TV products available. Our product range mainly includes computers and laptops. If you have any needs or questions about other products, please feel free to let us know.

## 2. Inner Monologue

In some application scenarios, it is not desirable to fully present the reasoning process of the language model, which may leak key information or answers. For example, in teaching applications, we hope that students can get conclusions through their own thinking rather than being directly told the answer.

In response to this problem. The "**Inner Monologue**" technique can hide the reasoning chain of the language model to a certain extent. Specifically, in the prompt, the language model is instructed to store the intermediate reasoning that needs to be hidden in a structured format, such as storing it as a variable. Then, when the result is returned, only the output that is valuable to the user is presented without showing the complete reasoning process.The display strategy only presents key information to the user and avoids revealing the answer. At the same time, the reasoning ability of the language model is also retained. Appropriate use of "inner monologue" can protect sensitive information while giving full play to the reasoning strengths of the language model.

In short, moderately hiding intermediate reasoning is one of the important techniques in Prompt engineering. Developers need to develop different information presentation strategies for different users. To maximize the value of the language model.

```python
try:
if delimiter in response:
final_response = response.split(delimiter)[-1].strip()
else:
final_response = response.split(":")[-1].strip()
except Exception as e:
final_response = "Sorry, I have a problem now, please try to ask another question"

print(final_response)
```

Sorry, we currently have no TV products available. Our product range mainly includes computers and laptops. If you have any needs or questions about other products, please feel free to let us know.

<br>
In complex tasksIn the process of task chaining, we often need the language model to interact multiple times and reason step by step to complete the whole process. If we want to complete all tasks in one prompt, the language model will be too demanding and the success rate will be low.

Therefore, the next chapter will introduce a more reliable strategy: decompose complex tasks into multiple subtasks and guide the language model to complete them step-by-step through prompt chaining. Specifically, we can analyze the different stages of the task and design a simple and clear prompt for each stage. We will show the use of prompt chaining through examples and how to scientifically split prompts to guide the language model to complete multi-step tasks progressively. This is one of the most important skills in prompt engineering.

## III. English version

**1.1 Thinking chain prompt**

```python
delimiter = "####"
system_message = f"""
Follow these steps to answer the customer queries.
The customer query will be delimited with four hashtags,\
i.e. {delimiter}. 

Step 1:{delimiter} First decide whenether the user is \
asking a question about a specific product or products. \
Product cateogry doesn't count. 

Step 2:{delimiter} If the user is asking about \
specific products, identify whether \
the products are in the following list.

All available products: 
1. Product: TechPro Ultrabook
Category: Computers and Laptops
Brand: TechPro
Model Number: TP-UB100
Warranty: 1 year
Rating: 4.5
Features: 13.3-inch display, 8GB RAM, 256GB SSD, Intel Core i5 processor
Description:A sleek and lightweight ultrabook for everyday use.
Price: $799.99

2. Product: BlueWave Gaming Laptop
Category: Computers and Laptops
Brand: BlueWave
Model Number: BW-GL200
Warranty: 2 years
Rating: 4.7
Features: 15.6-inch display, 16GB RAM, 512GB SSD, NVIDIA GeForce RTX 3060
Description: A high-performance gaming laptop for an immersive experience.
Price: $1199.99

3. Product: PowerLite Convertible
Category: Computers and Laptops
Brand: PowerLite
Model Numberr: PL-CV300
Warranty: 1 year
Rating: 4.3
Features: 14-inch touchscreen, 8GB RAM, 256GB SSD, 360-degree hinge
Description: A versatile convertible laptop with a responsive touchscreen.
Price: $699.99

4. Product: TechPro Desktop
Category: Computers and Laptops
Brand: TechPro
Model Number: TP-DT500
Warranty: 1 year
Rating: 4.4
Features: Intel Core i7 processor, 16GB RAM, 1TB HDD, NVIDIA GeForce GTX 1660
Description: A powerful desktop computer for work and play.Price: $999.99

5. Product: BlueWave Chromebook
Category: Computers and Laptops
Brand: BlueWave
Model Number: BW-CB100
Warranty: 1 year
Rating: 4.1
Features: 11.6-inch display, 4GB RAM, 32GB eMMC, Chrome OS
Description: A compact and affordable Chromebook for everyday tasks.
Price: $249.99

Step 3:{delimiter} If the message contains products \
in the list above, list any assumptions that the \
user is making in their \
message e.g. that Laptop X is bigger than \
Laptop Y, or that Laptop Z has a 2 year warranty.

Step 4:{delimiter}: If the user made any assumptions, \
figure out whether the assumption is true based on your \
product information. 

Step 5:{delimiter}: First, politely correct the \
customer's incorrect assumptions if applicable. \
Only mention or reference products in the list of \
5 available products, as these are the only 5 \
products that the store sells. \
Answer the customer in a friendly tone.

Use the following format:

Step 1:{delimiter} <step 1 reasoning>
Step 2:{delimiter} <step 2 reasoning>
Step 3:{delimiter} <step 3 reasoning>
Step 4:{delimiter} <step 4 reasoning>
Response to user:{delimiter} <response to customer>

Make sure to include {delimiter} to separate every step.
"""

```

```python
user_message = f"""
by how much is the BlueWave Chromebook more expensive \
than the TechPro Desktop"""

messages = [ 
{'role':'system', 
'content': system_message}, 
{'role':'user', 
'content': f"{delimiter}{user_message}{delimiter}"}, 
] 

response = get_completion_from_messages(messages)
print(response)
```

Step 1:#### The user is asking about the price difference between the BlueWave Chromebook and the TechPro Desktop.

Step 2:#### Both the BlueWave Chromebook and the TechPro Desktop are available products.

Step 3:#### The user assumes that the BlueWave Chromebook is more expensive than the TechPro Desktop.

Step 4:#### Based on the product information, the price of the BlueWave Chromebook ismebook is $249.99, and the price of the TechPro Desktop is $999.99. Therefore, the TechPro Desktop is actually more expensive than the BlueWave Chromebook.

Response to user:#### The BlueWave Chromebook is actually less expensive than the TechPro Desktop. The BlueWave Chromebook is priced at $249.99, while the TechPro Desktop is priced at $999.99.

```python
user_message = f"""
do you sell tvs"""
messages = [
{'role':'system',
'content': system_message},
{'role':'user',
'content': system_message}tent': f"{delimiter}{user_message}{delimiter}"}, 
] 
response = get_completion_from_messages(messages)
print(response)
```

Step 1:#### The user is asking if the store sells TVs, which is a question about a specific product category.

Step 2:#### TVs are not included in the list of available products. The store only sells computers and laptops.

Response to user:#### I'm sorry, but we currently do not sell TVs. Our store specializes in computers and laptops. If you have anyIf you have any questions or need assistance with our available products, feel free to ask.

**2.1 Inner Monologue**

```python
try:
final_response = response.split(delimiter)[-1].strip()
except Exception as e:
final_response = "Sorry, I'm having trouble right now, please try asking another question."

print(final_response)
```

I'm sorry, but we currently do not sell TVs. Our store specializes in computers and laptops. If you have any questions or need assistance with our available products, feel free too ask.