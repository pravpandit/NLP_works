# Chapter 7 Checking Results

As we progress through the book, this chapter will guide you through how to evaluate the output generated by the system. In any scenario, whether it is an automated process or other environment, we must ensure that the quality, relevance, and safety of the output are rigorously checked before it is displayed to the user to ensure that the feedback we provide is accurate and applicable. We will learn how to use the Moderation API to evaluate the output and explore how to improve the quality evaluation of the model before displaying the output through additional prompts.

## 1. Checking for harmful content
We mainly use the Moderation API provided by OpenAI to implement the check for harmful content.

```python
import openai
from tool import get_completion_from_messages

final_response_to_customer = f"""
The SmartX ProPhone has a 6.1-inch display, 128GB storage, 12-megapixel dual cameras, and 5G. The FotoSnap SLR camera has a 24.2-megapixel sensor, 1080p video, a 3-inch LCD, and interchangeable lenses. We have a variety of TVs, including CineView 4K TV, \
55" display, 4K resolution, HDR, and smart TV features. \
We also have SoundMax home theater systems with 5.1 channels, \
1000W output, wireless subwoofer, and Bluetooth. Do you have any specific questions about these products or \
any other products we offer?

""
# Moderation is OpenAI's content moderation function designed to assess and detect potential risks in text content.

response = openai.Moderation.create(
input=final_response_to_customer
)
moderation_output = response["results"][0]
print(moderation_output)
```

{
"categories": {
"harassment": false,
"harassment/threatening": false,
"hate": false,
"hate/threatening": false,
"self-harm": false,
"self-harm/instructions": false,
"self-harm/intent": false,
"sexual": false,
"sexual/minors": false,
"violence": false,
"violence/graphic": false
},
"category_scores": {
"harassment": 4.2861907e-07,
"harassment/threatening": 5.9538485e-09,
"hate": 2.079682e-07,
"hate/threatening": 5.6982725e-09,
"self-harm": 2.3966843e-08,
"self-harm/instructions": 1.5763412e-08,"self-harm/intent": 5.042827e-09,
"sexual": 2.6989035e-06,
"sexual/minors": 1.1349888e-06,
"violence": 1.2788286e-06,
"violence/graphic": 2.6259923e-07
},
"flagged": false
}

As you can see, this output is not flagged for any particular category and receives very low scores in all categories, which suggests that the results are reasonable.

It is also important to review the quality of output in general. For example, if you are building a chatbot for an audience with specific sensitivities to content, you can set a lower threshold for flagging output that may be problematic. Typically, if the review results show that something is flagged, you can take appropriate action, such as providing an alternative answer or generating a new response.

It is worth noting that as we continue to improve our models, they become less and less likely to produce harmful outputs.

Another way to check the quality of the output is to ask the model whether it is satisfied with the results it has generated and whether they meet the standards you set. This can be done byBy feeding the generated output as part of the input to the model again and asking it to evaluate the quality of the output. This operation can be done in a variety of ways. Next, we will show this approach through an example.

## 2. Check whether it is consistent with the product information

In the following example, we ask LLM as an assistant to check whether the response adequately answers the customer question and verify whether the facts cited by the assistant are correct.

```python
# This is a piece of information about electronic products
system_message = f"""
You are an assistant that evaluates whether the customer service agent's response adequately answers the customer's question, and verifies that all facts cited by the assistant from the product information are correct. 
The product information, user, and customer service agent information will be separated by three backticks (i.e. ```). 
Please respond with a character in the form of Y or N, without punctuation: \
Y - if the output adequately answers the question and the response correctly uses the product information\
N - otherwise.

Output only a single letter.
"""

#This is a customer's question
customer_message = f"""
Tell me about smartx pro phones\
and fotosnap cameras (SLR cameras).\
Also information about your TV.
"""
product_information = """{ "name": "SmartX ProPhone", "category": "Smartphones and Accessories", "brand": "SmartX", "model_number": "SX-PP10", "warranty": "1 year", "rating": 4.6, "features": [ "6.1-inch display", "128GB storage", "12MP dual camera", "5G" ], "description": "A powerful smartphone with advanced camera features.", "price": 899.99 } { "name": "FotoSnap DSLR Camera", "category": "Cameras and Camcorders", "brand": "FotoSnap", "model_number": "FS-DSLR200", "warranty": "1 year", "rating": 4.7, "features": [ "24.2MP sensor", "1080p video", "3-inch LCD", "Interchangeable lenses" ], "description": "Capture stunning photos and videos with this versatile DSLR camera.", "price": 599.99 } { "name": "CineView 4K TV", "category": "Televisions and Home Theater Systems", "brand": "CineView", "model_number": "CV-4K55", "warranty": "2 years", "rating": 4.8, "features": [ "55-inch display", "4K resolution", "HDR", "Smart TV" ], "description": "A stunning 4K TV with vibrant colors and smart features.", "price": 599.99} { "name": "SoundMax Home Theater", "category": "Televisions and Home Theater Systems", "brand": "SoundMax", "model_number": "SM-HT100", "warranty": "1 year", "rating": 4.4, "features": [ "5.1 channel", "1000W output", "Wireless subwoofer", "Bluetooth" ], "description": "A powerful home theater system for an immersive audio experience.", "price": 399.99 } { "name": "CineView 8K TV", "category": "Televisions and Home Theater Systems", "brand": "CineView", "model_number": "CV-8K65", "warranty": "2 years", "rating": 4.9, "features": [ "65-inch display", "8K resolution", "HDR", "Smart TV" ], "description": "Experience the future of television with this stunning 8K TV.", "price": 2999.99 } { "name": "SoundMax Soundbar", "category": "Televisions and Home Theater Systems", "brand": "SoundMax", "model_number": "SM-SB50", "warranty": "1 year", "rating": 4.3, "features": [ "2.1 channel", "300W output", "Wireless subwoofer", "Bluetooth" ], "description": "Upgrade your TV's audio with this sleekand powerful soundbar.", "price": 199.99 } { "name": "CineView OLED TV", "category": "Televisions and Home Theater Systems", "brand": "CineView", "model_number": "CV-OLED55", "warranty": "2 years", "rating": 4.7, "features": [ "55-inch display", "4K resolution", "HDR", "Smart TV" ], "description": "Experience true blacks and vibrant colors with this OLED TV.", "price": 1499.99 }"""

q_a_pair = f"""
Customer message: ```{customer_message}```
Product information: ```{product_information}```
Agent response: ```{final_response_to_customer}```

Does the response use the retrieved information correctly?

Does the response adequately answer the question?

Output Y or N
"""
#Judge relevance
messages = [
{'role': 'system', 'content': system_message},
{'role': 'user', 'content': q_a_pair}
]

response = get_completion_from_messages(messages, max_tokens=1)
print(response)
```

Y

In the previous example, we gave a positive example, and LLM made a good correct check. In the next example, we will provide a negative example, and LLM can also make a correct judgment.

```python
another_response = "Life is like a box of chocolates"
q_a_pair = f"""
Customer information: ```{customer_message}```
Product information: ```{product_information}```
Agent's response: ```{another_response}```

Whether the response uses the search correctlyInformation?
Does the response adequately answer the question?

Outputs Y or N
"""
messages = [
{'role': 'system', 'content': system_message},
{'role': 'user', 'content': q_a_pair}
]

response = get_completion_from_messages(messages)
print(response)
```

N

So, you can see that the model has the ability to provide feedback on the quality of the generated output. You can use this feedback to decide whether to show the output to the user or generate a new response. You can even try to generate multiple model responses for each user query and then pick the best response to show to the user. So, there are many possible ways to try.

In general, it is a good strategy to check the output with the help of the review API. But in my opinion, this may be unnecessary in most cases, especially when you are using more advanced models such as GPT-4. In fact, in real production environments, we donâ€™t see many people taking this approach. This approach will also increase the latency and cost of the system because you need to wait for additional API calls and require additional tokens. If your application or productThe error rate is only 0.0000001%, then you might want to try this strategy. But in general, we do not recommend using this approach in real applications. In the following chapters, we will integrate what we have learned about evaluating inputs, processing outputs, and reviewing generated content to build an end-to-end system.

## III. English version

**1.1 Checking for harmful information**

```python
final_response_to_customer = f"""
The SmartX ProPhone has a 6.1-inch display, 128GB storage, \
12MP dual camera, and 5G. The FotoSnap DSLR Camera \
has a 24.2MP sensor, 1080p video, 3-inch LCD, and \
interchangeable lenses. We have a variety of TVs, including \
the CineView 4K TV with a 55-inch display, 4K resolution, \
HDR, and smart TV features. We also has the SoundMax \
Home Theater system with 5.1 channel, 1000W output, wireless \
subwoofer, and Bluetooth. Do you have any specific questions \
about these products or any other products we offer?
"""

response = openai.Moderation.create(
input=final_response_to_customer
)
moderation_output = response["results"][0]
print(moderation_output)
```

{
"categories": {
"harassment": false,
"harassment/threatening": false,
"hate": false,
"hate/threatening": false,
"self-harm": false,
"self-harm/instructions": false,
"self-harm/intent": false,
"sexual": false,
"sexual/minors": false,
"violence": false,
"violence/graphic": false
},
"category_scores": {
"harassment": 3.4429521e-09,
"harassment/threatening": 9.538529e-10,
"hate": 6.0008998e-09,
"hate/threatening": 3.5339007e-10,
"self-harm": 5.6997046e-10,
"self-harm/instructions": 3.864466e-08,
"self-harm/intent": 9.3394e-10,
"sexual": 2.2777907e-07,
"sexual/minors": 2.6869095e-08,
"violence": 3.5471032e-07,
"violence/graphic": 7.8637696e-10
},
"flagged": false
}

**2.1 Check whether it complies with product information**

```python
# This is a piece of information related to electronic products
system_message = f"""
You are an assistant that evaluates whether \
customer service agent responses sufficiently \
answer customer questions, and also validates that \
all the facts the assistant cites from the product \
information is correct.
The product information and user and customer \
service agent messages will be delimited by \
3 backticks, i.e. ```.
Respond with a Y or N character, with no punctuation:
Y - if the output sufficiently answers the question \
AND the response correctly uses product information
N - otherwise

Output a single letter only.
"""

#This is a question from a customer
customer_message = f"""
tell me about the smartx pro phone and \
the fotosnap camera, the dslr one. \
Also tell me about your tvs"""
product_information = """{ "name": "SmartX ProPhone", "category": "Smartphones and Accessories", "brand": "SmartX", "model_number": "SX-PP10", "warranty": "1 year", "rating": 4.6, "features": [ "6.1-inch display", "128GB storage", "12MP dual camera", "5G" ], "description": "A powerful smartphone with advanced camera features.", "price": 899.99 } { "name": "FotoSnap DSLR Camera", "category": "Cameras and Camcorders", "brand": "FotoSnap", "model_number": "FS-DSLR200", "warranty": "1 year", "rating": 4.7, "features": [ "24.2MP sensor", "1080p video", "3-inch LCD", "Interchangeable lenses" ], "description": "Capture stunning photos and videos with this versatile DSLR camera.", "price": 599.99 } { "name": "CineView 4K TV", "category": "Televisions and Home Theater Systems", "brand": "CineView", "model_number": "CV-4K55", "warranty": "2 years", "rating": 4.8, "features": [ "55-inch display", "4K resolution", "HDR", "Smart TV" ], "description": "A stunning 4K TV with vibrant colorsand smart features.", "price": 599.99 } { "name": "SoundMax Home Theater", "category": "Televisions and Home Theater Systems", "brand": "SoundMax", "model_number": "SM-HT100", "warranty": "1 year", "rating": 4.4, "features": [ "5.1 channel", "1000W output", "Wireless subwoofer", "Bluetooth" ], "description": "A powerful home theater system for an immersive audio experience.", "price": 399.99 } { "name": "CineView 8K TV", "category": "Televisions and Home Theater Systems", "brand": "CineView", "model_number": "CV-8K65", "warranty": "2 years", "rating": 4.9, "features": [ "65-inch display", "8K resolution", "HDR", "Smart TV" ], "description": "Experience the future of television with this stunning 8K TV.", "price": 2999.99 } { "name": "SoundMax Soundbar", "category": "Televisions and Home Theater Systems", "brand": "SoundMax", "model_number": "SM-SB50", "warranty": "1 year", "rating": 4.3, "features": [ "2.1 channel", "300W output", "Wireless subwoofer", "Bluetooth" ], "description": "Upgrade your TV's audio with this sleek and powerful soundbar.", "price": 199.99 } { "name": "CineView OLED TV", "category": "Televisions and Home Theater Systems", "brand": "CineView", "model_number": "CV-OLED55", "warranty": "2 years", "rating": 4.7, "features": [ "55-inch display", "4K resolution", "HDR", "Smart TV" ], "description": "Experience true blacks and vibrant colors with this OLED TV.", "price": 1499.99 }"""

q_a_pair = f"""
Customer message: ```{customer_message}```
Product information: ```{product_information}```
Agent response: ```{final_response_to_customer}```

Does the response use the retrieved information correctly?

Does the response sufficiently answer the question?

Output Y or N
"""
#Judge relevance
messages = [
{'role': 'system', 'content': system_message},
{'role': 'user', 'content': q_a_pair}
]

response = get_completion_from_messages(messages, max_tokens=1)
print(response)
```

Y

```python
another_response = "life is like a box of chocolates"
q_a_pair = f"""
Customer message: ```{customer_message}```
Product information: ```{product_information}```
Agent response: ```{another_response}```

Does the response use the retrieved information correctly?

Does the response sufficiently answer the question?

Output Y or N
"""
messages = [
{'role': 'system', 'content': system_message},
{'role': 'user', 'content': q_a_pair}
]

response = get_completion_from_messages(messages)
print(response)
```

N